<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kids Art Tales - Demo</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Microsoft YaHei", sans-serif;
      margin: 24px;
      line-height: 1.5;
    }

    h1 {
      margin: 0 0 8px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }

    section {
      border: 1px solid #8884;
      border-radius: 12px;
      padding: 16px;
    }

    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #9996;
      cursor: pointer;
    }

    input,
    select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #9996;
      width: 100%;
      box-sizing: border-box;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .row>* {
      flex: 1;
    }

    .muted {
      opacity: 0.75;
      font-size: 12px;
    }

    pre {
      background: #00000008;
      padding: 12px;
      border-radius: 8px;
      overflow: auto;
    }

    .media {
      display: grid;
      gap: 8px;
    }

    .kpis {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .kpi {
      padding: 8px 12px;
      border-radius: 999px;
      background: #7c3aed18;
      border: 1px solid #7c3aed42;
    }
  </style>
  <script>
    async function jsonFetch(url, opts) {
      const res = await fetch(url, opts);
      const text = await res.text();
      try { return { ok: res.ok, status: res.status, json: JSON.parse(text) }; }
      catch { return { ok: res.ok, status: res.status, json: text }; }
    }

    async function checkHealth() {
      const r = await jsonFetch('/health');
      document.getElementById('healthOut').textContent = JSON.stringify(r, null, 2);
    }

    async function createUser() {
      const name = document.getElementById('userName').value || 'Kid Artist';
      const r = await jsonFetch('/api/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
      document.getElementById('userOut').textContent = JSON.stringify(r.json, null, 2);
      if (r.ok && r.json?.id) document.getElementById('userId').value = r.json.id;
    }

    async function getUser() {
      const id = document.getElementById('userId').value.trim();
      if (!id) return alert('Please enter User ID');
      const r = await jsonFetch(`/api/users/${id}`);
      document.getElementById('userOut').textContent = JSON.stringify(r.json, null, 2);
    }

    async function genImageToVoice() {
      const voiceText = document.getElementById('voiceText').value;
      const image = document.getElementById('imgInput1').files[0];
      const fd = new FormData();
      if (image) fd.append('image', image);
      if (voiceText) fd.append('voiceText', voiceText);
      const res = await fetch('/api/media/image-to-voice', { method: 'POST', body: fd });
      const data = await res.json();
      document.getElementById('mediaOut').textContent = JSON.stringify(data, null, 2);
    }

    async function genImageToImage() {
      const prompt = document.getElementById('imgPrompt').value;
      const image = document.getElementById('imgInput2').files[0];
      const fd = new FormData();
      if (image) fd.append('image', image);
      if (prompt) fd.append('prompt', prompt);
      const res = await fetch('/api/media/image-to-image', { method: 'POST', body: fd });
      const data = await res.json();
      document.getElementById('mediaOut').textContent = JSON.stringify(data, null, 2);
      if (data.imageUrl) {
        const img = document.getElementById('previewImg');
        img.src = data.imageUrl; img.alt = 'generated'; img.style.display = 'block';
      }
    }

    async function genImageToVideo() {
      const prompt = document.getElementById('videoPrompt').value;
      const image = document.getElementById('imgInput3').files[0];
      const fd = new FormData();
      if (image) fd.append('image', image);
      if (prompt) fd.append('prompt', prompt);
      const res = await fetch('/api/media/image-to-video', { method: 'POST', body: fd });
      const data = await res.json();
      document.getElementById('mediaOut').textContent = JSON.stringify(data, null, 2);
    }

    async function listWorks() {
      const r = await jsonFetch('/api/community/works');
      document.getElementById('communityOut').textContent = JSON.stringify(r.json, null, 2);
    }

    async function publishWork() {
      const authorId = document.getElementById('userId').value.trim() || 'anon';
      const type = document.getElementById('workType').value;
      const title = document.getElementById('workTitle').value || 'Untitled';
      const r = await jsonFetch('/api/community/works', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ authorId, type, title, canCoCreate: true }) });
      document.getElementById('communityOut').textContent = JSON.stringify(r.json, null, 2);
      if (r.ok && r.json?.id) document.getElementById('workId').value = r.json.id;
    }

    async function likeWork() {
      const id = document.getElementById('workId').value.trim();
      if (!id) return alert('Please enter Work ID');
      const r = await jsonFetch(`/api/community/works/${id}/like`, { method: 'POST' });
      document.getElementById('communityOut').textContent = JSON.stringify(r.json, null, 2);
    }

    async function coCreate() {
      const id = document.getElementById('workId').value.trim();
      const authorId = document.getElementById('userId').value.trim() || 'anon';
      if (!id) return alert('Please enter Work ID');
      const r = await jsonFetch(`/api/community/works/${id}/cocreate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ authorId }) });
      document.getElementById('communityOut').textContent = JSON.stringify(r.json, null, 2);
    }

    async function viewPlans() {
      const r = await jsonFetch('/api/subscriptions/plans');
      document.getElementById('subsOut').textContent = JSON.stringify(r.json, null, 2);
    }

    async function viewUsage() {
      const id = document.getElementById('userId').value.trim();
      if (!id) return alert('Please create or enter User ID');
      const r = await jsonFetch(`/api/subscriptions/${id}/usage`);
      document.getElementById('subsOut').textContent = JSON.stringify(r.json, null, 2);
    }

    async function consumeQuota() {
      const id = document.getElementById('userId').value.trim();
      if (!id) return alert('Please create or enter User ID');
      const type = document.getElementById('quotaType').value;
      const r = await jsonFetch(`/api/subscriptions/${id}/consume`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type }) });
      document.getElementById('subsOut').textContent = JSON.stringify(r.json, null, 2);
    }
  </script>
</head>

<body>
  <h1>Kids Art Tales - Demo Page</h1>
  <div class="muted">Quickly experience backend capabilities: Health Check, Users, Media Generation, Community,
    Subscription</div>
  <div class="kpis">
    <span class="kpi">GET <code>/docs</code> for Swagger API Docs</span>
    <span class="kpi">Static assets from <code>/public</code></span>
  </div>

  <div class="grid" style="margin-top:16px;">
    <section>
      <h3>Health Check</h3>
      <div class="row">
        <button onclick="checkHealth()">Check /health</button>
      </div>
      <pre id="healthOut">Click button above to run</pre>
    </section>

    <section>
      <h3>Users</h3>
      <div class="row">
        <input id="userName" placeholder="Username, default Kid Artist" />
        <button onclick="createUser()">Create User</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="userId" placeholder="User ID (Auto-filled)" />
        <button onclick="getUser()">Get User</button>
      </div>
      <pre id="userOut">Waiting...</pre>
    </section>

    <section>
      <h3>Media Generation</h3>
      <div class="media">
        <div class="row">
          <input id="voiceText" placeholder="Image Story Keywords (Optional)" />
          <input id="imgInput1" type="file" accept="image/*" />
          <button onclick="genImageToVoice()">Image → Audio</button>
        </div>
        <div class="row">
          <input id="imgPrompt" placeholder="Cartoon Prompt (Optional)" />
          <input id="imgInput2" type="file" accept="image/*" />
          <button onclick="genImageToImage()">Image → Image</button>
        </div>
        <div class="row">
          <input id="videoPrompt" placeholder="Animation Prompt (Optional)" />
          <input id="imgInput3" type="file" accept="image/*" />
          <button onclick="genImageToVideo()">Image → Video</button>
        </div>
        <img id="previewImg" style="max-width:100%;display:none;border-radius:8px;border:1px solid #9996;" />
      </div>
      <pre id="mediaOut">Waiting...</pre>
    </section>

    <section>
      <h3>Community Works</h3>
      <div class="row">
        <select id="workType">
          <option value="audio">audio</option>
          <option value="picture">picture</option>
          <option value="animation">animation</option>
        </select>
        <input id="workTitle" placeholder="Work Title (Optional)" />
      </div>
      <div class="row" style="margin-top:8px;">
        <button onclick="publishWork()">Publish Work</button>
        <button onclick="listWorks()">List Works</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <input id="workId" placeholder="Work ID (Auto-filled)" />
        <button onclick="likeWork()">Like</button>
        <button onclick="coCreate()">Co-Create</button>
      </div>
      <pre id="communityOut">Waiting...</pre>
    </section>

    <section>
      <h3>Subscription & Quota</h3>
      <div class="row">
        <button onclick="viewPlans()">View Plans</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <select id="quotaType">
          <option value="pictureBooks">pictureBooks</option>
          <option value="animations">animations</option>
          <option value="audioStories">audioStories</option>
        </select>
        <button onclick="viewUsage()">View Usage</button>
        <button onclick="consumeQuota()">Consume Quota</button>
      </div>
      <pre id="subsOut">Waiting...</pre>
    </section>
  </div>

  <p class="muted">For more APIs, visit <a href="/docs" target="_blank" rel="noreferrer">Swagger Docs</a>.</p>
</body>

</html>